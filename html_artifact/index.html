<html lang="zh-CN"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>羽毛球明星2048</title>
  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#ff0000',
            secondary: '#000000',
            accent: '#ffffff',
            'tile-bg': {
              2: '#fff0f0',
              4: '#ffd6d6',
              8: '#ffadad',
              16: '#ff8585',
              32: '#ff5c5c',
              64: '#ff3333',
              128: '#ff0000',
              256: '#cc0000',
              512: '#990000',
              1024: '#660000',
              2048: '#330000'
            }
          },
          fontFamily: {
            'inter': ['Inter', 'sans-serif'],
            'sans': ['Inter', 'sans-serif'],
          },
          boxShadow: {
            'inner-lg': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.06)',
            'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
          },
          backdropBlur: {
            'glass': '4px',
          },
        }
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .text-shadow-lg {
        text-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      .glass-effect {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      .tile-inner {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        border-radius: 0.5rem;
        font-weight: bold;
        z-index: 10;
        transition: transform 0.15s ease, opacity 0.15s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .tile-inner img {
        width: 70%;
        height: 70%;
        object-fit: contain;
        margin-bottom: 0.25rem;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
      }
      .tile-inner img.loaded {
        opacity: 1;
      }
      .tile-inner .name {
        font-size: 0.75rem;
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .tile-merged .tile-inner {
        animation: pop 0.2s ease-in-out;
        z-index: 20;
      }
      @keyframes pop {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }
      @keyframes victoryAppear {
        0% {
          opacity: 0;
          transform: scale(0.8) rotate(-5deg);
          filter: blur(10px);
        }
        50% {
          transform: scale(1.1) rotate(3deg);
        }
        100% {
          opacity: 1;
          transform: scale(1) rotate(0);
          filter: blur(0);
        }
      }
      .victory-card {
        animation: victoryAppear 2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .game-message {
        display: none;
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 100;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        animation: fadeIn 0.5s ease-in-out;
        border-radius: 0.5rem;
      }
      .game-message.game-won, .game-message.game-over {
        display: flex;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .game-message .message {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 1rem;
        font-family: 'Inter', sans-serif;
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      }
      .game-message .quote {
        font-size: 1.2rem;
        margin-bottom: 2rem;
        color: white;
        font-family: 'Inter', sans-serif;
        max-width: 80%;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      }
      .game-message button {
        font-size: 1.2rem;
        padding: 0.5rem 1.5rem;
        border-radius: 0.25rem;
        background: white;
        color: #333;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s ease;
        font-family: 'Inter', sans-serif;
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      .game-message button:hover {
        background: #f0f0f0;
      }
      .game-message button:active {
        transform: translateY(2px);
      }
      .custom-select {
        position: relative;
        display: inline-block;
        width: 100%;
      }
      .custom-select select {
        appearance: none;
        -webkit-appearance: none;
        width: 100%;
        padding: 0.5rem;
        border-radius: 0.25rem;
        border: 1px solid #ddd;
        background-color: white;
        cursor: pointer;
        font-family: 'Inter', sans-serif;
      }
      .custom-select::after {
        content: '\25BC';
        position: absolute;
        top: 50%;
        right: 0.75rem;
        transform: translateY(-50%);
        pointer-events: none;
      }
      .portrait-preview {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid #ddd;
        margin: 1rem auto;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f9f9f9;
      }
      .portrait-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .upload-btn {
        display: block;
        width: 100%;
        padding: 0.5rem 1rem;
        background-color: #f0f0f0;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-family: 'Inter', sans-serif;
      }
      .upload-btn:hover {
        background-color: #e0e0e0;
      }
      .upload-btn input.hidden {
        display: none;
      }
      .restore-btn {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background-color: #f0f0f0;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-family: 'Inter', sans-serif;
        border: none;
      }
      .restore-btn:hover {
        background-color: #e0e0e0;
      }
      .ink-stroke {
        position: relative;
      }
      .ink-stroke::after {
        content: '';
        position: absolute;
        bottom: -5px;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(to right, transparent, #000, transparent);
      }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen font-inter">
<div class="relative w-full min-h-screen overflow-hidden" style="min-height: 100vh; display: flex; flex-direction: column;">
    <!-- 背景 -->
    <div class="absolute inset-0 z-0">
      <div class="absolute inset-0 bg-gradient-to-br from-red-700 to-black opacity-70"></div>
      <!-- 羽毛球纹理背景 -->
      <div class="absolute inset-0 opacity-5">
        <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
          <pattern id="badminton-pattern" width="100" height="100" patternUnits="userSpaceOnUse">
            <circle cx="50" cy="50" r="8" fill="#ffffff" />
            <path d="M50,42 L50,58 M42,50 L58,50" stroke="#ffffff" stroke-width="2" />
          </pattern>
          <rect width="100%" height="100%" fill="url(#badmintonminton-pattern)" />
        </svg>
      </div>
    </div>

    <!-- 主容器 -->
    <div class="relative z-10 container mx-auto px-4 py-8 md:py-12 max-w-6xl flex-grow flex flex-col">
      <!-- 标题区 -->
      <header class="mb-8 text-center">
        <div class="flex justify-center items-center relative">
          <h1 class="text-3xl md:text-4xl font-inter text-primary font-bold">羽毛球明星2048</h1>
          <div class="absolute right-0 md:right-auto md:left-full md:ml-4 top-0 transform md:translate-x-0 translate-x-16 -translate-y-4 bg-red-600 px-2 py-1 rounded">
            <span class="text-lg font-inter text-white font-bold">BWF</span>
          </div>
        </div>
        <p class="mt-4 text-lg text-gray-700 max-w-2xl mx-auto font-inter">轻移方向，合并同类，从新秀到世界冠军，层层递进</p>
      </header>

      <!-- 主要内容区 -->
      <div class="flex flex-col md:flex-row justify-center items-start gap-8 mt-8">
        <!-- 游戏棋盘区 -->
        <div class="relative">
          <div class="game-container bg-red-900 bg-opacity-80 rounded-lg p-4 shadow-lg border-4 border-black" style="box-shadow: 0 10px 25px rgba(0,0,0,0.5), 0 6px 12px rgba(0,0,0,0.3), inset 0 1px 3px rgba(255,255,255,0.1);">
            <div class="grid grid-cols-4 gap-4 bg-black bg-opacity-70 rounded-lg p-4" id="game-board" style="width: 100%; max-width: 500px; height: 500px; margin: 0 auto;">
              <!-- 棋盘格子将通过JS动态生成 -->
            </div>

            <!-- 分数区域 -->
            <div class="flex justify-between mt-3 text-white">
              <div class="flex flex-col items-center">
                <span class="text-sm opacity-75 font-inter" style="font-weight: bold; font-size: 16px;">当前积分</span>
                <span class="text-xl font-bold font-inter" id="score">0</span>
              </div>
              <div class="flex flex-col items-center">
                <span class="text-sm opacity-75 font-inter" style="font-weight: bold; font-size: 16px;">最高积分</span>
                <span class="text-xl font-bold font-inter" id="best-score">0</span>
              </div>
            </div>
          </div>

          <!-- 游戏结束/胜利消息 -->
          <div class="game-message" id="game-message">
            <div class="victory-card bg-white bg-opacity-90 p-8 rounded-lg shadow-xl max-w-md">
              <div class="message text-3xl font-bold mb-6" id="message-text">恭喜获得世界冠军!</div>
              <div class="quote text-xl mb-6" id="quote-text">每一次挥拍，都是向胜利的冲刺！</div>
              <div class="flex gap-4 justify-center">
                <button id="try-again-btn" class="bg-red-600 text-white hover:bg-opacity-80">再来赛</button>
                <button id="continue-btn" class="bg-black text-white hover:bg-gray-800 hidden">继续挑战</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 右侧自定义区 -->
        <div class="w-full md:w-64 glass-effect rounded rounded-lg rounded rounded-md shadow-xl" style="min-height: 530px; align-self: flex-start; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); border: 2px solid rgba(255,255,255,0.3);">
          <h2 class="text-2xl font-inter text-center mb-4 ink-stroke inline-block relative text-white font-bold" style="font-size: 22px; text-shadow: 2px 2px 0 #000;">球员配置</h2>

          <!-- 球员下拉选择 -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2 font-inter">球员选择</label>
            <div class="custom-select">
              <select id="character-select">
                <option value="">选择球员...</option>
                <option value="2">2-韩悦</option>
                <option value="4">4-乔纳坦</option>
                <option value="8">8-山口茜</option>
                <option value="16">16-安东森</option>
                <option value="32">32-王祉怡</option>
                <option value="64">64-李诗沣</option>
                <option value="128">128-昆拉武特</option>
                <option value="256">256-陈雨菲</option>
                <option value="512">512-安洗莹</option>
                <option value="1024">1024-石宇奇</option>
                <option value="2048">2048-世界冠军</option>
              </select>
            </div>
          </div>

          <!-- 被选择球员预览 -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2 font-inter">预览</label>
            <div class="portrait-preview" id="portrait-preview">
              <img src="" alt="球员预览" id="preview-image" class="hidden">
              <span id="preview-placeholder" class="text-gray-400">选择球员</span>
            </div>
          </div>

          <!-- 上传提示 -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2 font-inter">自定义头像</label>
            <label for="image-upload" class="upload-btn text-center w-full cursor-pointer bg-red-600 text-white">
              <input type="file" id="image-upload" accept="image/*" class="hidden">
              <span class="font-inter">上传球员照片</span>
              <p class="text-xs text-gray-200 mt-1 font-inter">建议上传1:1比例图片</p>
            </label>
          </div>

          <!-- 复原按钮 -->
          <button id="restore-btn" class="restore-btn w-full font-inter bg-black text-white">复原默认</button>

          <!-- 悔棋按钮 -->
          <button id="undo-btn" class="mt-4 w-full bg-red-600 text-white py-2 px-4 rounded hover:bg-opacity-80 transition-colors font-inter">
            <i class="fa fa-undo mr-2"></i>悔棋
          </button>

        </div>
      </div>

      <!-- 操作提示 -->
      <div class="mt-12 text-center text-gray-600 text-sm">
        <p class="font-inter">操作方式：键盘方向键 ↑ ↓ ← → 或触摸滑动</p>
      </div>
    </div>
  </div>

  <script>
    // 球员配置表
    const characterConfig = {
      2: {
        name: "韩悦",
        description: "中国选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/453e8e4bc2f84f189454f7110d878908~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084187&x-signature=9ABAXVGBr8w315ocspawXFRgk24%3D"
      },
      4: {
        name: "乔纳坦",
        description: "印尼选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/15063c908fb94e9f88aadc6905f3b6c9~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084199&x-signature=FiPBtD7U0o6UGA%2FqZwDRRAOjyw8%3D"
      },
      8: {
        name: "山口茜",
        description: "日本选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/0aaf359a7a6141bc9fb9a665c61b73ac~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084207&x-signature=NRBi1W9j1X%2BFbsFizzKPREs1p2c%3D"
      },
      16: {
        name: "安东森",
        description: "丹麦选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/5cf2081672ab469bbddd1fe27e4209b4~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084198&x-signature=kxiEcD%2BFNnz%2FJ3NckuhX5rTV%2FAk%3D"
      },
      32: {
        name: "王祉怡",
        description: "中国选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/f388395c863e4f43be853d42ce326199~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084185&x-signature=9qYiWfMruqZxBfqCPCX%2BjM2R5%2Fo%3D"
      },
      64: {
        name: "李诗沣",
        description: "中国选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/4f1d2c6ccce24cb8aefa2f58b4be304e~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084177&x-signature=Dq7bGecGdVOnDdACCg3SW6rCE1w%3D"
      },
      128: {
        name: "昆拉武特",
        description: "泰国选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/00750c8333144d8b8f62b0f3c0ed1479~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084177&x-signature=ijinIKP7%2FA1EX0Y1ugGcatRnRKk%3D"
      },
      256: {
        name: "陈雨菲",
        description: "中国选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/6e6d155ac2164b53a0569c093fc931e7~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084208&x-signature=udSxjehcHEy7GFiqnPtXB0sJuac%3D"
      },
      512: {
        name: "安洗莹",
        description: "韩国选手",
        image: "https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/d55c21a5f5a84f6aa5cd203f7a850fdc~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084187&x-signature=yY5%2BxS6qjrn0B6SY5KYjY3EfTuM%3D"
      },
      1024: {
        name: "石宇奇",
        description: "中国选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/af392c3a47274a19b84b0a223e02d203~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084188&x-signature=2uo3efrEGsP1GnAp1HUHbGuBDTA%3D"
      },
      2048: {
        name: "世界冠军",
        description: "终极目标",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/af392c3a47274a19b84b0a223e02d203~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084188&x-signature=2uo3efrEGsP1GnAp1HUHbGuBDTA%3D"
      }
    };

    // 游戏核心逻辑
    class Game2048 {
      constructor() {
        console.log('Game2048 构造函数被调用');
        this.imageCache = {}; // 保留图片缓存对象，但简化实现
        this.size = 4; // 4x4 棋盘
        this.board = [];
        this.score = 0;
        this.bestScore = localStorage.getItem('bestScore') || 0;
        this.previousState = null; // 用于悔棋
        this.customPortraits = JSON.parse(localStorage.getItem('customPortraits')) || {};
        this.won = false;
        this.over = false;

        // 初始化DOM元素
        this.gameBoard = document.getElementById('game-board');
        this.scoreDisplay = document.getElementById('score');
        this.bestScoreDisplay = document.getElementById('best-score');
        this.gameMessage = document.getElementById('game-message');
        this.messageText = document.getElementById('message-text');
        this.quoteText = document.getElementById('quote-text');
        this.tryAgainBtn = document.getElementById('try-again-btn');
        this.continueBtn = document.getElementById('continue-btn');
        this.characterSelect = document.getElementById('character-select');
        this.portraitPreview = document.getElementById('portrait-preview');
        this.previewImage = document.getElementById('preview-image');
        this.previewPlaceholder = document.getElementById('preview-placeholder');
        this.imageUpload = document.getElementById('image-upload');
        this.restoreBtn = document.getElementById('restore-btn');
        this.undoBtn = document.getElementById('undo-btn');

        // 初始化游戏
        this.setup();

        // 添加事件监听器
        this.setupEventListeners();

        // 游戏初始化完成
      }

      // 初始化游戏
      setup() {
        console.log('游戏设置开始');
        // 清空localStorage中的自定义头像，避免加载问题
        localStorage.removeItem('customPortraits');
        this.customPortraits = {};
        // 创建棋盘格子
        this.gameBoard.innerHTML = '';
        this.gameBoard.style.gridTemplateColumns = `repeat(${this.size}, 1fr)`;

        // 创建固定的格子元素
        for (let i = 0; i < this.size * this.size; i++) {
          const tile = document.createElement('div');
          tile.className = 'bg-white bg-opacity-20 rounded-lg flex items-center justify-center aspect-square';
          this.gameBoard.appendChild(tile);
        }

        // 创建空棋盘数据
        this.board = Array(this.size).fill().map(() => Array(this.size).fill(0));

        // 更新分数显示
        this.scoreDisplay.textContent = this.score;
        this.bestScoreDisplay.textContent = this.bestScore;

        // 预加载图片 - 性能优化的核心
        this.preloadImages();

        // 随机放置两个初始棋子
        this.addRandomTile();
        this.addRandomTile();

        // 渲染棋盘
        this.renderBoard();

        // 重置游戏状态
        this.won = false;
        this.over = false;
        this.gameMessage.classList.remove('game-won', 'game-over');
      }

      // 保存当前状态用于悔棋
      saveState() {
        this.previousState = {
          board: JSON.parse(JSON.stringify(this.board)),
          score: this.score
        };
      }

      // 悔棋
      undo() {
        if (this.previousState) {
          this.board = this.previousState.board;
          this.score = this.previousState.score;
          this.scoreDisplay.textContent = this.score;
          this.renderBoard();
          this.previousState = null; // 只能悔棋一次
        }
      }

      // 添加随机棋子
      addRandomTile() {
        // 获取所有空格子
        const emptyTiles = [];
        for (let i = 0; i < this.size; i++) {
          for (let j = 0; j < this.size; j++) {
            if (this.board[i][j] === 0) {
              emptyTiles.push({ x: i, y: j });
            }
          }
        }

        // 如果有空格子，随机选择一个并放置棋子
        if (emptyTiles.length > 0) {
          const randomTile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
          // 90%概率生成2，10%概率生成4
          this.board[randomTile.x][randomTile.y] = Math.random() < 0.9 ? 2 : 4;
          return true;
        }
        return false;
      }

      

      // 渲染棋盘
      renderBoard() {
        // 渲染每个格子
        const tiles = this.gameBoard.children;

        for (let i = 0; i < this.size; i++) {
          for (let j = 0; j < this.size; j++) {
            const index = i * this.size + j;
            const value = this.board[i][j];
            const tile = tiles[index];

            if (value !== 0) {
              // 检查是否已有相同值的棋子内容
              const existingValue = tile.dataset.value;
              const existingSrc = tile.dataset.src;
              const newSrc = this.customPortraits[value] || characterConfig[value].image;

              if (existingValue === value.toString() && existingSrc === newSrc) {
                // 棋子值和图片源都相同，跳过重新渲染
                continue;
              }

              // 设置新值和源标记
              tile.dataset.value = value.toString();
              tile.dataset.src = newSrc;

              // 获取或创建棋子内部元素
              let tileInner = tile.querySelector('.tile-inner');
              if (!tileInner) {
                tileInner = document.createElement('div');
                tileInner.className = 'tile-inner rounded-lg shadow-inner-lg';
                tile.appendChild(tileInner);
              }

              // 获取角色配置
              const config = characterConfig[value];

              // 设置棋子背景色
              const bgColor = value <= 2048 ? `var(--tw-color-tile-bg-${value})` : '#330000';
              tileInner.style.backgroundColor = bgColor;

              // 获取或创建图片元素
              let img = tileInner.querySelector('img');
              if (!img) {
                img = document.createElement('img');
                img.alt = config.name;
                tileInner.appendChild(img);
              }

              // 获取或创建名称元素
              let name = tileInner.querySelector('.name');
              if (!name) {
                name = document.createElement('div');
                name.className = 'name';
                tileInner.appendChild(name);
              }

              // 改进图片加载
              if (img.getAttribute('data-current-src') !== newSrc) {
                img.setAttribute('data-current-src', newSrc);
                img.style.display = 'block';
                img.src = newSrc;
                img.onload = () => {
                  img.classList.add('loaded');
                  name.style.fontSize = '0.75rem';
                };
                img.onerror = () => {
                  // 图片加载失败时显示默认文字和背景
                  img.style.display = 'none';
                  name.style.fontSize = '1rem';
                  name.textContent = value;
                  tileInner.style.backgroundColor = '#f0f0f0';
                };
              }

              name.textContent = config.name;

              // 标记为已渲染
              tile.classList.add('tile-rendered');

              // 显示棋子
              tile.classList.remove('bg-white', 'bg-opacity-20');
            } else {
              // 清空标记和内容
              delete tile.dataset.value;
              delete tile.dataset.src;
              tile.classList.remove('tile-rendered');
              tile.innerHTML = '';
              tile.className = 'bg-white bg-opacity-20 rounded-lg flex items-center justify-center aspect-square';
            }
          }
        }
      }

      // 移动棋子
      move(direction) {
        // 如果游戏已结束，不执行移动
        if (this.over || this.won) return false;

        // 保存当前状态用于悔棋
        this.saveState();

        // 创建一个副本用于比较移动前后的状态
        const previousBoard = JSON.parse(JSON.stringify(this.board));
        let moved = false;

        // 根据方向执行移动
        switch (direction) {
          case 'up':
            moved = this.moveUp();
            break;
          case 'right':
            moved = this.moveRight();
            break;
          case 'down':
            moved = this.moveDown();
            break;
          case 'left':
            moved = this.moveLeft();
            break;
        }

        // 如果有移动，添加新棋子并检查游戏状态
        if (moved) {
          this.playMoveSound(); // 播放移动音效
          this.addRandomTile();
          this.renderBoard();
          this.checkGameStatus();
        } else {
          // 如果没有移动，清除悔棋状态
          this.previousState = null;
        }

        return moved;
      }

      // 向上移动
      moveUp() {
        let moved = false;

        for (let j = 0; j < this.size; j++) {
          for (let i = 1; i < this.size; i++) {
            if (this.board[i][j] !== 0) {
              let row = i;
              while (row > 0 && this.board[row - 1][j] === 0) {
                this.board[row - 1][j] = this.board[row][j];
                this.board[row][j] = 0;
                row--;
                moved = true;
              }

              if (row > 0 && this.board[row - 1][j] === this.board[row][j]) {
                this.board[row - 1][j] *= 2;
                this.score += this.board[row - 1][j];
                this.board[row][j] = 0;
                moved = true;

                // 播放合并音效
                this.playMergeSound();
              }
            }
          }
        }

        if (moved) {
          this.scoreDisplay.textContent = this.score;
          this.updateBestScore();
        }

        return moved;
      }

      // 向右移动
      moveRight() {
        let moved = false;

        for (let i = 0; i < this.size; i++) {
          for (let j = this.size - 2; j >= 0; j--) {
            if (this.board[i][j] !== 0) {
              let col = j;
              while (col < this.size - 1 && this.board[i][col + 1] === 0) {
                this.board[i][col + 1] = this.board[i][col];
                this.board[i][col] = 0;
                col++;
                moved = true;
              }

              if (col < this.size - 1 && this.board[i][col + 1] === this.board[i][col]) {
                this.board[i][col + 1] *= 2;
                this.score += this.board[i][col + 1];
                this.board[i][col] = 0;
                moved = true;

                // 播放合并音效
                this.playMergeSound();
              }
            }
          }
        }

        if (moved) {
          this.scoreDisplay.textContent = this.score;
          this.updateBestScore();
        }

        return moved;
      }

      // 向下移动
      moveDown() {
        let moved = false;

        for (let j = 0; j < this.size; j++) {
          for (let i = this.size - 2; i >= 0; i--) {
            if (this.board[i][j] !== 0) {
              let row = i;
              while (row < this.size - 1 && this.board[row + 1][j] === 0) {
                this.board[row + 1][j] = this.board[row][j];
                this.board[row][j] = 0;
                row++;
                moved = true;
              }

              if (row < this.size - 1 && this.board[row + 1][j] === this.board[row][j]) {
                this.board[row + 1][j] *= 2;
                this.score += this.board[row + 1][j];
                this.board[row][j] = 0;
                moved = true;

                // 播放合并音效
                this.playMergeSound();
              }
            }
          }
        }

        if (moved) {
          this.scoreDisplay.textContent = this.score;
          this.updateBestScore();
        }

        return moved;
      }

      // 向左移动
      moveLeft() {
        let moved = false;

        for (let i = 0; i < this.size; i++) {
          for (let j = 1; j < this.size; j++) {
            if (this.board[i][j] !== 0) {
              let col = j;
              while (col > 0 && this.board[i][col - 1] === 0) {
                this.board[i][col - 1] = this.board[i][col];
                this.board[i][col] = 0;
                col--;
                moved = true;
              }

              if (col > 0 && this.board[i][col - 1] === this.board[i][col]) {
                this.board[i][col - 1] *= 2;
                this.score += this.board[i][col - 1];
                this.board[i][col] = 0;
                moved = true;

                // 播放合并音效
                this.playMergeSound();
              }
            }
          }
        }

        if (moved) {
          this.scoreDisplay.textContent = this.score;
          this.updateBestScore();
        }

        return moved;
      }

      // 播放移动音效
      playMoveSound() {
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          // 简单的移动音效
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(300, audioContext.currentTime + 0.1);

          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

          oscillator.start();
          oscillator.stop(audioContext.currentTime + 0.1);
        } catch (error) {
          console.log('音频播放不支持或被禁用');
        }
      }

      // 播放合并音效
      playMergeSound() {
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          // 合并音效
          oscillator.type = 'triangle';
          oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.2);

          gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

          oscillator.start();
          oscillator.stop(audioContext.currentTime + 0.2);
        } catch (error) {
          console.log('音频播放不支持或被禁用');
        }
      }

      // 更新最高分
      updateBestScore() {
        if (this.score > this.bestScore) {
          this.bestScore = this.score;
          this.bestScoreDisplay.textContent = this.bestScore;
          localStorage.setItem('bestScore', this.bestScore);
        }
      }

      // 检查游戏状态
      checkGameStatus() {
        // 检查是否达成2048（胜利）
        if (!this.won) {
          for (let i = 0; i < this.size; i++) {
            for (let j = 0; j < this.size; j++) {
              if (this.board[i][j] === 2048) {
                this.won = true;
                this.messageText.textContent = '太虚幻境';
                this.quoteText.textContent = '太虚幻境乃天上之境...「千红一哭，万艳同悲」';
                this.gameMessage.classList.add('game-won');
                this.continueBtn.classList.remove('hidden');
                return;
              }
            }
          }
        }

        // 检查是否还有空格子
        for (let i = 0; i < this.size; i++) {
          for (let j = 0; j < this.size; j++) {
            if (this.board[i][j] === 0) {
              return; // 还有空格子，游戏继续
            }
          }
        }

        // 检查是否还有可合并的棋子
        for (let i = 0; i < this.size; i++) {
          for (let j = 0; j < this.size; j++) {
            const value = this.board[i][j];

            // 检查右侧
            if (j < this.size - 1 && value === this.board[i][j + 1]) {
              return; // 可以合并，游戏继续
            }

            // 检查下方
            if (i < this.size - 1 && value === this.board[i + 1][j]) {
              return; // 可以合并，游戏继续
            }
          }
        }

        // 没有空格子且没有可合并的棋子，游戏结束
        this.over = true;
        this.messageText.textContent = '盛筵必散';
        this.quoteText.textContent = '盛筵必散，且待重来';
        this.gameMessage.classList.add('game-over');
        this.continueBtn.classList.add('hidden');
      }

      // 设置事件监听器
      setupEventListeners() {
        // 键盘控制
        document.addEventListener('keydown', (e) => {
          switch (e.key) {
            case 'ArrowUp':
              e.preventDefault();
              this.move('up');
              break;
            case 'ArrowRight':
              e.preventDefault();
              this.move('right');
              break;
            case 'ArrowDown':
              e.preventDefault();
              this.move('down');
              break;
            case 'ArrowLeft':
              e.preventDefault();
              this.move('left');
              break;
          }
        });

        // 触摸控制
        let touchStartX, touchStartY;
        const gameContainer = document.querySelector('.game-container');

        gameContainer.addEventListener('touchstart', (e) => {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
          e.preventDefault();
        }, { passive: false });

        gameContainer.addEventListener('touchmove', (e) => {
          e.preventDefault();
        }, { passive: false });

        gameContainer.addEventListener('touchend', (e) => {
          if (!touchStartX || !touchStartY) return;

          const touchEndX = e.changedTouches[0].clientX;
          const touchEndY = e.changedTouches[0].clientY;

          const dx = touchEndX - touchStartX;
          const dy = touchEndY - touchStartY;

          // 最小滑动距离为50px
          if (Math.abs(dx) > 50 || Math.abs(dy) > 50) {
            if (Math.abs(dx) > Math.abs(dy)) {
              // 水平滑动
              this.move(dx > 0 ? 'right' : 'left');
            } else {
              // 垂直滑动
              this.move(dy > 0 ? 'down' : 'up');
            }
          }

          touchStartX = null;
          touchStartY = null;
          e.preventDefault();
        }, { passive: false });

        // 按钮事件
        this.tryAgainBtn.addEventListener('click', () => {
          this.setup();
        });

        this.continueBtn.addEventListener('click', () => {
          this.gameMessage.classList.remove('game-won');
          this.won = false;
        });

        // 人物选择事件
        this.characterSelect.addEventListener('change', () => {
          const value = this.characterSelect.value;
          if (value) {
            const config = characterConfig[value];
            this.previewImage.src = this.customPortraits[value] || config.image;
            this.previewImage.alt = config.name;
            this.previewImage.classList.remove('hidden');
            this.previewPlaceholder.classList.add('hidden');
          } else {
            this.previewImage.classList.add('hidden');
            this.previewPlaceholder.classList.remove('hidden');
          }
        });

        // 图片上传事件
        this.imageUpload.addEventListener('change', (e) => {
          const file = e.target.files[0];
          const value = this.characterSelect.value;

          if (file) {
            if (!value) {
              alert('请先选择要自定义的人物角色');
              e.target.value = ''; // 清空文件选择
              return;
            }

            const reader = new FileReader();

            reader.onload = (event) => {
              const dataUrl = event.target.result;

              // 保存自定义头像到localStorage
              this.customPortraits[value] = dataUrl;
              localStorage.setItem('customPortraits', JSON.stringify(this.customPortraits));

              // 预加载并缓存新图片
              this.preloadSingleImage(value, dataUrl).then(() => {
                // 更新预览
                this.previewImage.src = dataUrl;
                this.previewImage.classList.remove('hidden');
                this.previewPlaceholder.classList.add('hidden');

                // 重新渲染棋盘以应用新头像
                this.renderBoard();

                alert('自定义头像上传成功!');
              }).catch((error) => {
                console.error('Failed to cache uploaded image:', error);
                alert('头像上传失败，请重试!');
              });
            };

            reader.readAsDataURL(file);
          }
        });

        // 复原描摹按钮事件
        this.restoreBtn.addEventListener('click', () => {
          const value = this.characterSelect.value;

          if (value) {
            // 删除自定义头像
            delete this.customPortraits[value];
            localStorage.setItem('customPortraits', JSON.stringify(this.customPortraits));

            // 清除缓存中的自定义图片，重新加载默认图片
            const config = characterConfig[value];
            this.preloadSingleImage(value, config.image).then(() => {
              // 更新预览
              this.previewImage.src = config.image;
              this.previewImage.classList.remove('hidden');
              this.previewPlaceholder.classList.add('hidden');

              // 重新渲染棋盘
              this.renderBoard();
            });
          }
        });

        // 悔棋按钮事件
        this.undoBtn.addEventListener('click', () => {
          this.undo();
        });
      }
    }

    // 初始化游戏
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM 已加载，初始化游戏...');
      try {
        const game = new Game2048();
        console.log('游戏初始化成功！');
      } catch (error) {
        console.error('游戏初始化失败:', error);
        alert('游戏加载失败，请刷新页面重试！');
      }
    });
  </script>

</body></html>