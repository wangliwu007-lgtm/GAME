<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>羽毛球明星2048 - 可传播版</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Bangers&display=swap" rel="stylesheet">
  
  <!-- 自定义Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#ff0000',
            secondary: '#000000',
            accent: '#ffffff',
            'tile-bg': {
              2: '#fff0f0',
              4: '#ffd6d6',
              8: '#ffadad',
              16: '#ff8585',
              32: '#ff5c5c',
              64: '#ff3333',
              128: '#ff0000',
              256: '#cc0000',
              512: '#990000',
              1024: '#660000',
              2048: '#330000'
            }
          },
          fontFamily: {
            'inter': ['Inter', 'sans-serif'],
            'bangers': ['Bangers', 'cursive'],
          },
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .text-shadow-lg {
        text-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      .glass-effect {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      .tile-inner {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        border-radius: 0.5rem;
        font-weight: bold;
        z-index: 10;
        transition: transform 0.15s ease, opacity 0.15s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .tile-inner img {
        width: 70%;
        height: 70%;
        object-fit: contain;
        margin-bottom: 0.25rem;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
        background-color: transparent;
        border-radius: 50%;
      }
      .tile-inner img.loaded {
        opacity: 1;
      }
      .tile-inner .name {
        font-size: 0.75rem;
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        color: white;
      }
      .tile-merged .tile-inner {
        animation: pop 0.2s ease-in-out;
        z-index: 20;
      }
      @keyframes pop {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
      }
      @keyframes victoryAppear {
        0% {
          opacity: 0;
          transform: scale(0.8) rotate(-5deg);
          filter: blur(10px);
        }
        50% { transform: scale(1.1) rotate(3deg); }
        100% {
          opacity: 1;
          transform: scale(1) rotate(0);
          filter: blur(0);
        }
      }
      .victory-card {
        animation: victoryAppear 2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .game-message {
        display: none;
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 100;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        animation: fadeIn 0.5s ease-in-out;
        border-radius: 0.5rem;
      }
      .game-message.game-won, .game-message.game-over {
        display: flex;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .share-button {
        transition: all 0.3s ease;
      }
      .share-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }
      .floating {
        animation: float 3s ease-in-out infinite;
      }
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
      }
      .pulse {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
      .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: #f00;
        animation: confetti 5s ease-in-out infinite;
      }
      @keyframes confetti {
        0% { transform: translateY(0) rotate(0deg); opacity: 1; }
        100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
      }
      .achievement-popup {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 15px;
        display: flex;
        align-items: center;
        z-index: 1000;
        transform: translateX(120%);
        transition: transform 0.3s ease;
      }
      .achievement-popup.show {
        transform: translateX(0);
      }
      .achievement-icon {
        background-color: #ffc107;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen font-inter overflow-x-hidden">
  <!-- 背景 -->
  <div class="fixed inset-0 z-0">
    <div class="absolute inset-0 bg-gradient-to-br from-red-700 to-black opacity-70"></div>
    <!-- 羽毛球纹理背景 -->
    <div class="absolute inset-0 opacity-5">
      <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
        <pattern id="badminton-pattern" width="100" height="100" patternUnits="userSpaceOnUse">
          <circle cx="50" cy="50" r="8" fill="#ffffff" />
          <path d="M50,42 L50,58 M42,50 L58,50" stroke="#ffffff" stroke-width="2" />
        </pattern>
        <rect width="100%" height="100%" fill="url(#badminton-pattern)" />
      </svg>
    </div>
  </div>

  <!-- 顶部分享栏 -->
  <div class="fixed top-0 left-0 right-0 bg-white bg-opacity-95 shadow-md z-50 px-4 py-2">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center">
        <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/af392c3a47274a19b84b0a223e02d203~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084188&x-signature=2uo3efrEGsP1GnAp1HUHbGuBDTA%3D" alt="Logo" class="w-10 h-10 rounded-full mr-2">
        <h2 class="text-xl font-bangers text-red-600">羽毛球明星2048</h2>
      </div>
      <div class="flex space-x-2">
        <button id="share-button-1" class="share-button bg-blue-600 text-white p-2 rounded-full">
          <i class="fa fa-share-alt"></i>
        </button>
        <button id="copy-button" class="share-button bg-gray-800 text-white p-2 rounded-full">
          <i class="fa fa-copy"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- 主容器 -->
  <div class="relative z-10 container mx-auto px-4 pt-24 pb-16 max-w-lg flex-grow flex flex-col">
    <!-- 标题区 -->
    <header class="mb-6 text-center">
      <h1 class="text-4xl md:text-5xl font-bangers text-white font-extrabold tracking-tight relative inline-block" style="letter-spacing: 2px; text-shadow: 3px 3px 0 #000, 5px 5px 0 #ff0000;">
        <span class="relative z-10">羽毛球明星2048</span>
        <span class="absolute -bottom-2 left-0 w-full h-3 bg-yellow-400 transform -skew-x-12 opacity-70"></span>
      </h1>
      <p class="mt-4 text-lg text-white max-w-md mx-auto font-inter font-medium bg-black bg-opacity-30 py-2 px-4 rounded-lg shadow-md">
        合并相同等级的球员，挑战世界冠军！
      </p>
    </header>

    <!-- 游戏信息 -->
    <div class="flex justify-between items-center mb-4">
      <div class="bg-red-600 text-white p-3 rounded-lg shadow-md">
        <div class="text-sm opacity-75">得分</div>
        <div class="text-2xl font-bold" id="score">0</div>
      </div>
      <div class="flex space-x-2">
        <button id="undo-btn" class="bg-white text-red-600 p-3 rounded-lg shadow-md hover:bg-gray-100 transition-colors">
          <i class="fa fa-undo"></i>
        </button>
        <button id="restart-btn" class="bg-white text-red-600 p-3 rounded-lg shadow-md hover:bg-gray-100 transition-colors">
          <i class="fa fa-refresh"></i>
        </button>
      </div>
    </div>

    <!-- 游戏棋盘区 -->
    <div class="relative">
      <div class="game-container bg-red-900 bg-opacity-80 rounded-lg p-3 shadow-xl border-4 border-black">
        <div class="grid grid-cols-4 gap-2 bg-black bg-opacity-70 rounded-md p-2" id="game-board" style="width: 100%; aspect-ratio: 1/1; margin: 0 auto; box-sizing: border-box;">
          <!-- 棋盘格子将通过JS动态生成 -->
        </div>
      </div>

      <!-- 游戏结束/胜利消息 -->
      <div class="game-message" id="game-message">
        <div class="victory-card bg-white bg-opacity-95 p-6 rounded-lg shadow-2xl max-w-md border-4 border-red-600">
          <div class="message text-2xl font-bold mb-4" id="message-text">恭喜获得世界冠军!</div>
          <div class="quote text-lg mb-6" id="quote-text">每一次挥拍，都是向胜利的冲刺！</div>
          
          <!-- 分享按钮 -->
          <div class="flex flex-wrap justify-center gap-3 mb-6">
            <button id="share-button-2" class="share-button bg-blue-600 text-white px-4 py-2 rounded-lg">
              <i class="fa fa-share-alt mr-2"></i> 分享游戏
            </button>
            <button id="copy-button-2" class="share-button bg-gray-800 text-white px-4 py-2 rounded-lg">
              <i class="fa fa-copy mr-2"></i> 复制链接
            </button>
          </div>
          
          <div class="flex gap-3 justify-center">
            <button id="try-again-btn" class="bg-red-600 text-white hover:bg-opacity-80 px-6 py-3 rounded-lg text-lg font-bold transition-all transform hover:scale-105">再来赛</button>
            <button id="continue-btn" class="bg-black text-white hover:bg-gray-800 hidden px-6 py-3 rounded-lg text-lg font-bold transition-all transform hover:scale-105">继续挑战</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 操作提示 -->
    <div class="mt-6 text-center text-white text-sm bg-black bg-opacity-30 py-2 px-4 rounded-lg">
      <p>操作方式：滑动屏幕或使用方向键</p>
    </div>

    <!-- 排行榜 -->
    <div class="mt-6 bg-white bg-opacity-90 rounded-lg p-4 shadow-lg">
      <h3 class="text-lg font-bold text-red-600 mb-3 flex items-center">
        <i class="fa fa-trophy mr-2 text-yellow-500"></i> 好友排行榜
      </h3>
      <div class="space-y-2" id="leaderboard">
        <div class="flex justify-between items-center p-2 bg-gray-100 rounded">
          <div class="flex items-center">
            <span class="w-6 h-6 bg-yellow-500 text-white rounded-full flex items-center justify-center mr-2">1</span>
            <span>神秘玩家</span>
          </div>
          <span class="font-bold">2048</span>
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-100 rounded">
          <div class="flex items-center">
            <span class="w-6 h-6 bg-gray-400 text-white rounded-full flex items-center justify-center mr-2">2</span>
            <span>羽毛球爱好者</span>
          </div>
          <span class="font-bold">1024</span>
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-100 rounded">
          <div class="flex items-center">
            <span class="w-6 h-6 bg-amber-700 text-white rounded-full flex items-center justify-center mr-2">3</span>
            <span>你</span>
          </div>
          <span class="font-bold">0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 底部分享提示 -->
  <div class="fixed bottom-0 left-0 right-0 bg-white bg-opacity-95 shadow-md z-40 p-3">
    <div class="container mx-auto text-center">
      <p class="text-sm text-gray-700 mb-2">喜欢这个游戏？分享给好友一起挑战吧！</p>
      <div class="flex justify-center space-x-3">
        <button id="share-button-3" class="share-button bg-blue-600 text-white px-4 py-1 rounded-lg text-sm">
          <i class="fa fa-share-alt mr-1"></i> 分享游戏
        </button>
        <button id="copy-button-3" class="share-button bg-gray-800 text-white px-4 py-1 rounded-lg text-sm">
          <i class="fa fa-copy mr-1"></i> 复制链接
        </button>
      </div>
    </div>
  </div>

  <!-- 分享模态框 -->
  <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h3 class="text-xl font-bold mb-4 text-center">分享游戏</h3>
      
      <div class="mb-6">
        <p class="text-center mb-4">选择分享方式：</p>
        <div class="flex justify-center space-x-4">
          <button id="share-qrcode" class="bg-green-600 text-white p-3 rounded-lg flex flex-col items-center">
            <i class="fa fa-qrcode text-2xl mb-2"></i>
            <span>扫码分享</span>
          </button>
          <button id="share-link" class="bg-blue-600 text-white p-3 rounded-lg flex flex-col items-center">
            <i class="fa fa-link text-2xl mb-2"></i>
            <span>链接分享</span>
          </button>
        </div>
      </div>
      
      <!-- 二维码区域 -->
      <div id="qrcode-container" class="hidden">
        <div class="text-center mb-3">
          <p>扫描二维码在手机上玩</p>
        </div>
        <div class="flex justify-center">
          <div id="qrcode" style="width: 200px; height: 200px;"></div>
        </div>
      </div>
      
      <!-- 链接区域 -->
      <div id="link-container" class="hidden">
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">游戏链接</label>
          <div class="flex">
            <input type="text" id="game-link" class="w-full p-2 border rounded-lg" readonly>
          </div>
        </div>
        <button id="copy-link-btn" class="w-full bg-gray-800 text-white py-2 rounded-lg">
          <i class="fa fa-copy mr-2"></i> 复制链接
        </button>
      </div>
      
      <div class="mt-6 text-center">
        <button id="close-share-modal" class="bg-red-600 text-white px-6 py-2 rounded-lg">
          关闭
        </button>
      </div>
    </div>
  </div>

  <!-- 成就弹窗 -->
  <div class="achievement-popup" id="achievement-popup">
    <div class="achievement-icon">
      <i class="fa fa-star"></i>
    </div>
    <div>
      <div class="font-bold" id="achievement-title">新成就！</div>
      <div id="achievement-description">你获得了512分！</div>
    </div>
  </div>

  <script>
    // 球员配置表
    const characterConfig = {
      2: {
        name: "韩悦",
        description: "中国选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/453e8e4bc2f84f189454f7110d878908~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084187&x-signature=9ABAXVGBr8w315ocspawXFRgk24%3D"
      },
      4: {
        name: "乔纳坦",
        description: "印尼选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/15063c908fb94e9f88aadc6905f3b6c9~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084199&x-signature=FiPBtD7U0o6UGA%2FqZwDRRAOjyw8%3D"
      },
      8: {
        name: "山口茜",
        description: "日本选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/0aaf359a7a6141bc9fb9a665c61b73ac~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084207&x-signature=NRBi1W9j1X%2BFbsFizzKPREs1p2c%3D"
      },
      16: {
        name: "安东森",
        description: "丹麦选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/5cf2081672ab469bbddd1fe27e4209b4~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084198&x-signature=kxiEcD%2BFNnz%2FJ3NckuhX5rTV%2FAk%3D"
      },
      32: {
        name: "王祉怡",
        description: "中国选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/f388395c863e4f43be853d42ce326199~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084185&x-signature=9qYiWfMruqZxBfqCPCX%2BjM2R5%2Fo%3D"
      },
      64: {
        name: "李诗沣",
        description: "中国选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/4f1d2c6ccce24cb8aefa2f58b4be304e~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084177&x-signature=Dq7bGecGdVOnDdACCg3SW6rCE1w%3D"
      },
      128: {
        name: "昆拉武特",
        description: "泰国选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/00750c8333144d8b8f62b0f3c0ed1479~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084177&x-signature=ijinIKP7%2FA1EX0Y1ugGcatRnRKk%3D"
      },
      256: {
        name: "陈雨菲",
        description: "中国选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/6e6d155ac2164b53a0569c093fc931e7~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084208&x-signature=udSxjehcHEy7GFiqnPtXB0sJuac%3D"
      },
      512: {
        name: "安洗莹",
        description: "韩国选手",
        image: "https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/d55c21a5f5a84f6aa5cd203f7a850fdc~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084187&x-signature=yY5%2BxS6qjrn0B6SY5KYjY3EfTuM%3D"
      },
      1024: {
        name: "石宇奇",
        description: "中国选手",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/af392c3a47274a19b84b0a223e02d203~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084188&x-signature=2uo3efrEGsP1GnAp1HUHbGuBDTA%3D"
      },
      2048: {
        name: "世界冠军",
        description: "终极目标",
        image: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/af392c3a47274a19b84b0a223e02d203~tplv-a9rns2rl98-image.image?rcl=202510150935150C70F757FDCC00DFFC1C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1763084188&x-signature=2uo3efrEGsP1GnAp1HUHbGuBDTA%3D"
      }
    };

    // 游戏核心逻辑
    class Game2048 {
      constructor() {
        this.size = 4; // 4x4 棋盘
        this.board = [];
        this.score = 0;
        this.bestScore = localStorage.getItem('bestScore') || 0;
        this.previousState = null; // 用于悔棋
        this.won = false;
        this.over = false;
        this.achievements = [];
        this.shareCount = 0;
        
        // 初始化DOM元素
        this.gameBoard = document.getElementById('game-board');
        this.scoreDisplay = document.getElementById('score');
        this.gameMessage = document.getElementById('game-message');
        this.messageText = document.getElementById('message-text');
        this.quoteText = document.getElementById('quote-text');
        this.tryAgainBtn = document.getElementById('try-again-btn');
        this.continueBtn = document.getElementById('continue-btn');
        this.undoBtn = document.getElementById('undo-btn');
        this.restartBtn = document.getElementById('restart-btn');
        this.achievementPopup = document.getElementById('achievement-popup');
        this.achievementTitle = document.getElementById('achievement-title');
        this.achievementDescription = document.getElementById('achievement-description');
        
        // 初始化游戏
        this.setup();
        
        // 添加事件监听器
        this.setupEventListeners();
        this.setupShareModal();
        
        // 检查URL参数，追踪分享来源
        this.trackShareSource();
      }
      
      // 初始化游戏
      setup() {
        // 清空游戏数据
        this.board = [];
        this.score = 0;
        this.previousState = null;
        
        // 创建棋盘格子
        this.gameBoard.innerHTML = '';
        this.gameBoard.style.gridTemplateColumns = `repeat(${this.size}, 1fr)`;
        
        // 创建固定的格子元素
        for (let i = 0; i < this.size * this.size; i++) {
          const tile = document.createElement('div');
          tile.className = 'bg-white bg-opacity-20 rounded-lg flex items-center justify-center';
          tile.style.aspectRatio = '1/1';
          tile.style.minHeight = '60px';
          this.gameBoard.appendChild(tile);
        }
        
        // 创建空棋盘数据
        this.board = Array(this.size).fill().map(() => Array(this.size).fill(0));
        
        // 更新分数显示
        this.scoreDisplay.textContent = this.score;
        
        // 随机放置两个初始棋子
        this.addRandomTile();
        this.addRandomTile();
        
        // 渲染棋盘
        this.renderBoard();
        
        // 重置游戏状态
        this.won = false;
        this.over = false;
        this.gameMessage.classList.remove('game-won', 'game-over');
        
        // 更新排行榜
        this.updateLeaderboard();
      }
      
      // 保存当前状态用于悔棋
      saveState() {
        this.previousState = {
          board: JSON.parse(JSON.stringify(this.board)),
          score: this.score
        };
      }
      
      // 悔棋
      undo() {
        if (this.previousState) {
          this.board = this.previousState.board;
          this.score = this.previousState.score;
          this.scoreDisplay.textContent = this.score;
          this.renderBoard();
          this.previousState = null; // 只能悔棋一次
        }
      }
      
      // 添加随机棋子
      addRandomTile() {
        // 获取所有空格子
        const emptyTiles = [];
        for (let i = 0; i < this.size; i++) {
          for (let j = 0; j < this.size; j++) {
            if (this.board[i][j] === 0) {
              emptyTiles.push({ x: i, y: j });
            }
          }
        }
        
        // 如果有空格子，随机选择一个并放置棋子
        if (emptyTiles.length > 0) {
          const randomTile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
          // 90%概率生成2，10%概率生成4
          this.board[randomTile.x][randomTile.y] = Math.random() < 0.9 ? 2 : 4;
          return true;
        }
        return false;
      }
      
      // 渲染棋盘
      renderBoard() {
        // 渲染每个格子
        const tiles = this.gameBoard.children;
        
        for (let i = 0; i < this.size; i++) {
          for (let j = 0; j < this.size; j++) {
            const index = i * this.size + j;
            const value = this.board[i][j];
            const tile = tiles[index];
            
            if (value !== 0) {
              // 检查是否已有相同值的棋子内容
              const existingValue = tile.dataset.value;
              const existingSrc = tile.dataset.src;
              const newSrc = characterConfig[value].image;
              
              if (existingValue === value.toString() && existingSrc === newSrc) {
                // 棋子值和图片源都相同，跳过重新渲染
                continue;
              }
              
              // 设置新值和源标记
              tile.dataset.value = value.toString();
              tile.dataset.src = newSrc;
              
              // 获取或创建棋子内部元素
              let tileInner = tile.querySelector('.tile-inner');
              if (!tileInner) {
                tileInner = document.createElement('div');
                tileInner.className = 'tile-inner rounded-lg shadow-inner-lg';
                tile.appendChild(tileInner);
              }
              
              // 获取角色配置
              const config = characterConfig[value];
              
              // 设置棋子背景色
              const bgColor = value <= 2048 ? `var(--tw-color-tile-bg-${value})` : '#330000';
              tileInner.style.backgroundColor = bgColor;
              
              // 获取或创建图片元素
              let img = tileInner.querySelector('img');
              if (!img) {
                img = document.createElement('img');
                img.alt = config.name;
                tileInner.appendChild(img);
              }
              
              // 获取或创建名称元素
              let name = tileInner.querySelector('.name');
              if (!name) {
                name = document.createElement('div');
                name.className = 'name';
                tileInner.appendChild(name);
              }
              
              // 改进图片加载
              if (img.getAttribute('data-current-src') !== newSrc) {
                img.setAttribute('data-current-src', newSrc);
                img.style.display = 'block';
                img.src = newSrc;
                img.onload = () => {
                  img.classList.add('loaded');
                  name.style.fontSize = '0.75rem';
                };
                img.onerror = () => {
                  // 图片加载失败时显示默认文字和背景
                  img.style.display = 'none';
                  name.style.fontSize = '1rem';
                  name.textContent = value;
                  tileInner.style.backgroundColor = '#f0f0f0';
                };
              }
              
              name.textContent = config.name;
              
              // 标记为已渲染
              tile.classList.add('tile-rendered');
              
              // 显示棋子
              tile.classList.remove('bg-white', 'bg-opacity-20');
            } else {
              // 清空标记和内容
              delete tile.dataset.value;
              delete tile.dataset.src;
              tile.classList.remove('tile-rendered');
              tile.innerHTML = '';
              tile.className = 'bg-white bg-opacity-20 rounded-lg flex items-center justify-center';
              tile.style.aspectRatio = '1/1';
              tile.style.minHeight = '60px';
            }
          }
        }
      }
      
      // 移动棋子
      move(direction) {
        // 如果游戏已结束，不执行移动
        if (this.over || this.won) return false;
        
        // 保存当前状态用于悔棋
        this.saveState();
        
        // 创建一个副本用于比较移动前后的状态
        const previousBoard = JSON.parse(JSON.stringify(this.board));
        let moved = false;
        
        // 根据方向执行移动
        switch (direction) {
          case 'up':
            moved = this.moveUp();
            break;
          case 'right':
            moved = this.moveRight();
            break;
          case 'down':
            moved = this.moveDown();
            break;
          case 'left':
            moved = this.moveLeft();
            break;
        }
        
        // 如果有移动，添加新棋子并检查游戏状态
        if (moved) {
          this.addRandomTile();
          this.renderBoard();
          this.checkGameStatus();
          this.checkAchievements();
        } else {
          // 如果没有移动，清除悔棋状态
          this.previousState = null;
        }
        
        return moved;
      }
      
      // 向上移动
      moveUp() {
        let moved = false;
        
        for (let j = 0; j < this.size; j++) {
          for (let i = 1; i < this.size; i++) {
            if (this.board[i][j] !== 0) {
              let row = i;
              while (row > 0 && this.board[row - 1][j] === 0) {
                this.board[row - 1][j] = this.board[row][j];
                this.board[row][j] = 0;
                row--;
                moved = true;
              }
              
              if (row > 0 && this.board[row - 1][j] === this.board[row][j]) {
                this.board[row - 1][j] *= 2;
                this.score += this.board[row - 1][j];
                this.board[row][j] = 0;
                moved = true;
              }
            }
          }
        }
        
        if (moved) {
          this.scoreDisplay.textContent = this.score;
          this.updateBestScore();
        }
        
        return moved;
      }
      
      // 向右移动
      moveRight() {
        let moved = false;
        
        for (let i = 0; i < this.size; i++) {
          for (let j = this.size - 2; j >= 0; j--) {
            if (this.board[i][j] !== 0) {
              let col = j;
              while (col < this.size - 1 && this.board[i][col + 1] === 0) {
                this.board[i][col + 1] = this.board[i][col];
                this.board[i][col] = 0;
                col++;
                moved = true;
              }
              
              if (col < this.size - 1 && this.board[i][col + 1] === this.board[i][col]) {
                this.board[i][col + 1] *= 2;
                this.score += this.board[i][col + 1];
                this.board[i][col] = 0;
                moved = true;
              }
            }
          }
        }
        
        if (moved) {
          this.scoreDisplay.textContent = this.score;
          this.updateBestScore();
        }
        
        return moved;
      }
      
      // 向下移动
      moveDown() {
        let moved = false;
        
        for (let j = 0; j < this.size; j++) {
          for (let i = this.size - 2; i >= 0; i--) {
            if (this.board[i][j] !== 0) {
              let row = i;
              while (row < this.size - 1 && this.board[row + 1][j] === 0) {
                this.board[row + 1][j] = this.board[row][j];
                this.board[row][j] = 0;
                row++;
                moved = true;
              }
              
              if (row < this.size - 1 && this.board[row + 1][j] === this.board[row][j]) {
                this.board[row + 1][j] *= 2;
                this.score += this.board[row + 1][j];
                this.board[row][j] = 0;
                moved = true;
              }
            }
          }
        }
        
        if (moved) {
          this.scoreDisplay.textContent = this.score;
          this.updateBestScore();
        }
        
        return moved;
      }
      
      // 向左移动
      moveLeft() {
        let moved = false;
        
        for (let i = 0; i < this.size; i++) {
          for (let j = 1; j < this.size; j++) {
            if (this.board[i][j] !== 0) {
              let col = j;
              while (col > 0 && this.board[i][col - 1] === 0) {
                this.board[i][col - 1] = this.board[i][col];
                this.board[i][col] = 0;
                col--;
                moved = true;
              }
              
              if (col > 0 && this.board[i][col - 1] === this.board[i][col]) {
                this.board[i][col - 1] *= 2;
                this.score += this.board[i][col - 1];
                this.board[i][col] = 0;
                moved = true;
              }
            }
          }
        }
        
        if (moved) {
          this.scoreDisplay.textContent = this.score;
          this.updateBestScore();
        }
        
        return moved;
      }
      
      // 更新最高分
      updateBestScore() {
        if (this.score > this.bestScore) {
          this.bestScore = this.score;
          localStorage.setItem('bestScore', this.bestScore);
        }
      }
      
      // 检查游戏状态
      checkGameStatus() {
        // 检查是否达成2048（胜利）
        if (!this.won) {
          for (let i = 0; i < this.size; i++) {
            for (let j = 0; j < this.size; j++) {
              if (this.board[i][j] === 2048) {
                this.won = true;
                this.messageText.textContent = '恭喜获得世界冠军!';
                this.quoteText.textContent = '每一次挥拍，都是向胜利的冲刺！';
                this.gameMessage.classList.add('game-won');
                this.continueBtn.classList.remove('hidden');
                
                // 显示庆祝效果
                this.showConfetti();
                
                // 解锁成就
                this.unlockAchievement('世界冠军', '你成功获得了2048分！');
                
                return;
              }
            }
          }
        }
        
        // 检查是否还有空格子
        for (let i = 0; i < this.size; i++) {
          for (let j = 0; j < this.size; j++) {
            if (this.board[i][j] === 0) {
              return; // 还有空格子，游戏继续
            }
          }
        }
        
        // 检查是否还有可合并的棋子
        for (let i = 0; i < this.size; i++) {
          for (let j = 0; j < this.size; j++) {
            const value = this.board[i][j];
            
            // 检查右侧
            if (j < this.size - 1 && value === this.board[i][j + 1]) {
              return; // 可以合并，游戏继续
            }
            
            // 检查下方
            if (i < this.size - 1 && value === this.board[i + 1][j]) {
              return; // 可以合并，游戏继续
            }
          }
        }
        
        // 没有空格子且没有可合并的棋子，游戏结束
        this.over = true;
        this.messageText.textContent = '挑战失败';
        this.quoteText.textContent = '永不言弃，挑战极限！';
        this.gameMessage.classList.add('game-over');
        this.continueBtn.classList.add('hidden');
        
        // 更新排行榜
        this.updateLeaderboard(true);
      }
      
      // 检查成就
      checkAchievements() {
        // 得分成就
        const scoreAchievements = [
          { id: 'score_100', title: '初露锋芒', description: '获得100分！', threshold: 100 },
          { id: 'score_500', title: '羽毛球爱好者', description: '获得500分！', threshold: 500 },
          { id: 'score_1000', title: '专业选手', description: '获得1000分！', threshold: 1000 },
          { id: 'score_2000', title: '世界排名前10', description: '获得2000分！', threshold: 2000 }
        ];
        
        // 检查得分成就
        scoreAchievements.forEach(achievement => {
          if (this.score >= achievement.threshold && !this.hasAchievement(achievement.id)) {
            this.unlockAchievement(achievement.title, achievement.description);
            this.achievements.push(achievement.id);
            localStorage.setItem('achievements', JSON.stringify(this.achievements));
          }
        });
        
        // 检查特殊棋子成就
        const tileAchievements = [
          { id: 'tile_128', title: '国家队水平', description: '合成128级球员！', value: 128 },
          { id: 'tile_512', title: '国际大赛选手', description: '合成512级球员！', value: 512 },
          { id: 'tile_1024', title: '世界顶尖选手', description: '合成1024级球员！', value: 1024 }
        ];
        
        // 检查是否有特殊棋子
        tileAchievements.forEach(achievement => {
          for (let i = 0; i < this.size; i++) {
            for (let j = 0; j < this.size; j++) {
              if (this.board[i][j] === achievement.value && !this.hasAchievement(achievement.id)) {
                this.unlockAchievement(achievement.title, achievement.description);
                this.achievements.push(achievement.id);
                localStorage.setItem('achievements', JSON.stringify(this.achievements));
                return;
              }
            }
          }
        });
      }
      
      // 解锁成就
      unlockAchievement(title, description) {
        this.achievementTitle.textContent = title;
        this.achievementDescription.textContent = description;
        this.achievementPopup.classList.add('show');
        
        // 3秒后隐藏
        setTimeout(() => {
          this.achievementPopup.classList.remove('show');
        }, 3000);
      }
      
      // 检查是否已有成就
      hasAchievement(id) {
        return this.achievements.includes(id);
      }
      
      // 显示庆祝效果
      showConfetti() {
        const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
        
        for (let i = 0; i < 100; i++) {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = `${Math.random() * 100}vw`;
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = `${Math.random() * 5}s`;
          document.body.appendChild(confetti);
          
          // 动画结束后移除
          setTimeout(() => {
            confetti.remove();
          }, 5000);
        }
      }
      
      // 更新排行榜
      updateLeaderboard(isFinal = false) {
        // 获取本地存储的排行榜数据
        let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
        
        // 如果是游戏结束，添加当前分数
        if (isFinal) {
          leaderboard.push({
            name: '你',
            score: this.score,
            date: new Date().toISOString()
          });
          
          // 按分数排序
          leaderboard.sort((a, b) => b.score - a.score);
          
          // 只保留前10名
          leaderboard = leaderboard.slice(0, 10);
          
          // 保存到本地存储
          localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
        }
        
        // 更新排行榜UI
        const leaderboardElement = document.getElementById('leaderboard');
        leaderboardElement.innerHTML = '';
        
        // 如果没有排行榜数据，显示默认数据
        if (leaderboard.length === 0) {
          leaderboardElement.innerHTML = `
            <div class="flex justify-between items-center p-2 bg-gray-100 rounded">
              <div class="flex items-center">
                <span class="w-6 h-6 bg-yellow-500 text-white rounded-full flex items-center justify-center mr-2">1</span>
                <span>神秘玩家</span>
              </div>
              <span class="font-bold">2048</span>
            </div>
            <div class="flex justify-between items-center p-2 bg-gray-100 rounded">
              <div class="flex items-center">
                <span class="w-6 h-6 bg-gray-400 text-white rounded-full flex items-center justify-center mr-2">2</span>
                <span>羽毛球爱好者</span>
              </div>
              <span class="font-bold">1024</span>
            </div>
            <div class="flex justify-between items-center p-2 bg-gray-100 rounded">
              <div class="flex items-center">
                <span class="w-6 h-6 bg-amber-700 text-white rounded-full flex items-center justify-center mr-2">3</span>
                <span>你</span>
              </div>
              <span class="font-bold">${this.score}</span>
            </div>
          `;
          return;
        }
        
        // 显示排行榜数据
        leaderboard.forEach((entry, index) => {
          const medalColors = ['bg-yellow-500', 'bg-gray-400', 'bg-amber-700'];
          const medalColor = index < 3 ? medalColors[index] : 'bg-gray-500';
          
          const entryElement = document.createElement('div');
          entryElement.className = 'flex justify-between items-center p-2 bg-gray-100 rounded';
          entryElement.innerHTML = `
            <div class="flex items-center">
              <span class="w-6 h-6 ${medalColor} text-white rounded-full flex items-center justify-center mr-2">${index + 1}</span>
              <span>${entry.name}</span>
            </div>
            <span class="font-bold">${entry.score}</span>
          `;
          
          leaderboardElement.appendChild(entryElement);
        });
      }
      
      // 设置事件监听器
      setupEventListeners() {
        // 键盘控制
        document.addEventListener('keydown', (e) => {
          switch (e.key) {
            case 'ArrowUp':
              e.preventDefault();
              this.move('up');
              break;
            case 'ArrowRight':
              e.preventDefault();
              this.move('right');
              break;
            case 'ArrowDown':
              e.preventDefault();
              this.move('down');
              break;
            case 'ArrowLeft':
              e.preventDefault();
              this.move('left');
              break;
          }
        });
        
        // 触摸控制
        let touchStartX, touchStartY;
        const gameContainer = document.querySelector('.game-container');
        
        gameContainer.addEventListener('touchstart', (e) => {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
          e.preventDefault();
        }, { passive: false });
        
        gameContainer.addEventListener('touchmove', (e) => {
          e.preventDefault();
        }, { passive: false });
        
        gameContainer.addEventListener('touchend', (e) => {
          if (!touchStartX || !touchStartY) return;
          
          const touchEndX = e.changedTouches[0].clientX;
          const touchEndY = e.changedTouches[0].clientY;
          
          const dx = touchEndX - touchStartX;
          const dy = touchEndY - touchStartY;
          
          // 最小滑动距离为50px
          if (Math.abs(dx) > 50 || Math.abs(dy) > 50) {
            if (Math.abs(dx) > Math.abs(dy)) {
              // 水平滑动
              this.move(dx > 0 ? 'right' : 'left');
            } else {
              // 垂直滑动
              this.move(dy > 0 ? 'down' : 'up');
            }
          }
          
          touchStartX = null;
          touchStartY = null;
          e.preventDefault();
        }, { passive: false });
        
        // 按钮事件
        this.tryAgainBtn.addEventListener('click', () => {
          this.setup();
        });
        
        this.continueBtn.addEventListener('click', () => {
          this.gameMessage.classList.remove('game-won');
          this.won = false;
        });
        
        // 悔棋按钮事件
        this.undoBtn.addEventListener('click', () => {
          this.undo();
        });
        
        // 重新开始按钮事件
        this.restartBtn.addEventListener('click', () => {
          if (confirm('确定要重新开始游戏吗？')) {
            this.setup();
          }
        });
      }
      
      // 设置分享模态框
      setupShareModal() {
        const shareModal = document.getElementById('share-modal');
        const shareButton1 = document.getElementById('share-button-1');
        const shareButton2 = document.getElementById('share-button-2');
        const shareButton3 = document.getElementById('share-button-3');
        const copyButton = document.getElementById('copy-button');
        const copyButton2 = document.getElementById('copy-button-2');
        const copyButton3 = document.getElementById('copy-button-3');
        const closeShareModal = document.getElementById('close-share-modal');
        const shareQrcode = document.getElementById('share-qrcode');
        const shareLink = document.getElementById('share-link');
        const qrcodeContainer = document.getElementById('qrcode-container');
        const linkContainer = document.getElementById('link-container');
        const gameLink = document.getElementById('game-link');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        
        // 当前页面URL
        const currentUrl = window.location.href;
        
        // 设置游戏链接
        gameLink.value = currentUrl;
        
        // 打开分享模态框
        function openShareModal() {
          shareModal.classList.remove('hidden');
          // 默认显示二维码
          showQRCode();
        }
        
        // 关闭分享模态框
        closeShareModal.addEventListener('click', () => {
          shareModal.classList.add('hidden');
        });
        
        // 点击模态框外部关闭
        shareModal.addEventListener('click', (e) => {
          if (e.target === shareModal) {
            shareModal.classList.add('hidden');
          }
        });
        
        // 显示二维码
        function showQRCode() {
          qrcodeContainer.classList.remove('hidden');
          linkContainer.classList.add('hidden');
          
          // 生成二维码
          QRCode.toCanvas(document.getElementById('qrcode'), currentUrl, {
            width: 200,
            margin: 10
          }, function(error) {
            if (error) console.error(error);
          });
        }
        
        // 显示链接
        function showLink() {
          qrcodeContainer.classList.add('hidden');
          linkContainer.classList.remove('hidden');
          gameLink.select();
        }
        
        // 复制链接
        function copyGameLink() {
          gameLink.select();
          document.execCommand('copy');
          alert('链接已复制到剪贴板！');
          this.trackShare('copy');
        }
        
        // 绑定事件
        shareButton1.addEventListener('click', openShareModal);
        shareButton2.addEventListener('click', openShareModal);
        shareButton3.addEventListener('click', openShareModal);
        
        copyButton.addEventListener('click', () => {
          copyGameLink();
        });
        
        copyButton2.addEventListener('click', () => {
          copyGameLink();
        });
        
        copyButton3.addEventListener('click', () => {
          copyGameLink();
        });
        
        shareQrcode.addEventListener('click', showQRCode);
        shareLink.addEventListener('click', showLink);
        copyLinkBtn.addEventListener('click', copyGameLink);
      }
      
      // 追踪分享
      trackShare(method) {
        this.shareCount++;
        
        // 解锁分享成就
        if (this.shareCount === 1 && !this.hasAchievement('share_first')) {
          this.unlockAchievement('分享达人', '首次分享游戏！');
          this.achievements.push('share_first');
          localStorage.setItem('achievements', JSON.stringify(this.achievements));
        }
        
        if (this.shareCount >= 3 && !this.hasAchievement('share_master')) {
          this.unlockAchievement('分享大师', '分享游戏3次以上！');
          this.achievements.push('share_master');
          localStorage.setItem('achievements', JSON.stringify(this.achievements));
        }
        
        console.log(`Shared using ${method}, total shares: ${this.shareCount}`);
      }
      
      // 追踪分享来源
      trackShareSource() {
        const urlParams = new URLSearchParams(window.location.search);
        const source = urlParams.get('source');
        
        if (source) {
          console.log(`Game opened from share source: ${source}`);
        }
      }
    }

    // 初始化游戏
    document.addEventListener('DOMContentLoaded', () => {
      try {
        // 加载QRCode库
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js';
        script.onload = () => {
          console.log('QRCode library loaded');
          const game = new Game2048();
          console.log('游戏初始化成功！');
        };
        script.onerror = () => {
          console.error('QRCode library failed to load');
          // 即使QRCode加载失败，也继续初始化游戏
          const game = new Game2048();
          console.log('游戏初始化成功！');
        };
        document.head.appendChild(script);
      } catch (error) {
        console.error('游戏初始化失败:', error);
        alert('游戏加载失败，请刷新页面重试！');
      }
    });
  </script>
</body>
</html>
